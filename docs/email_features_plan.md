# План реализации почтовых сценариев

## 1. Подтверждение бронирования клиенту
1. **Определить триггер:**
   - Обработчик `POST /appointments` на бэкенде.
2. **Подготовить шаблон письма:**
   - Создать файл шаблона с параметрами: имя клиента, название услуги, время встречи, контакты бизнеса.
3. **Интегрировать отправку письма:**
   - После сохранения встречи вызвать сервис уведомлений (например, `EmailService.sendBookingConfirmation`).
   - Передавать необходимые данные из созданной записи.
4. **Настроить отправку через Brevo (SMTP):**
   - Использовать уже имеющиеся SMTP-параметры Brevo из конфигурации окружения.
   - Проверить корректность подключения (аутентификация, TLS) и задать понятный `from`-адрес.
5. **Покрыть тестами:**
   - Юнит-тест сервиса уведомлений.
   - Интеграционный тест эндпоинта для проверки вызова уведомления.

## 2. Уведомление владельца бизнеса о новой заявке
1. **Получение email владельца:**
   - При создании встречи запросить/использовать email из `GET /businesses/:id` (из кэша или предварительно загруженных данных).
2. **Шаблон письма для владельца:**
   - Содержимое: данные клиента, услуга, желаемое время, комментарии.
3. **Логика отправки:**
   - В обработчике `POST /appointments` после создания записи инициировать вторую отправку на адрес владельца.
   - Использовать общий SMTP-адаптер Brevo, чтобы не дублировать настройки.
4. **Обработка ошибок:**
   - Логировать неудачные отправки и предусмотреть повторную попытку фоновой задачей.
5. **Тесты:**
   - Проверка, что при успешном бронировании выполняется вызов рассылки владельцу.

## 3. Письма при изменении статуса, переносе или отмене встречи
1. **Определить события:**
   - Обработчики `PUT /appointments/:id`, `POST /appointments/:id/cancel`, изменение статуса администратором.
2. **Единый сервис уведомлений:**
   - Расширить сервис для отправки писем клиенту и бизнесу при любом обновлении.
   - Использовать шаблоны для каждого типа события (перенос, отмена, подтверждение).
   - Обеспечить переиспользование подключения к Brevo для всех типов писем.
3. **Обновление данных для шаблона:**
   - Передавать предыдущие и новые параметры бронирования, комментарии администратора.
4. **Тестирование:**
   - Юнит-тесты на генерацию корректного текста и получателей.
   - Интеграционные тесты эндпоинтов на триггеры рассылок.

## 4. Напоминания перед визитом
1. **Фоновая задача:**
   - Настроить планировщик (например, cron/job queue) для ежедневного запуска.
2. **Выборка встреч:**
   - Запрос всех встреч на следующий день с активным статусом.
3. **Отправка писем:**
   - Для каждой встречи вызывать `EmailService.sendReminder` с краткими деталями и ссылкой на отмену/перенос.
   - Отправку производить через Brevo SMTP с контролем лимитов и ретраями.
4. **Логирование и мониторинг:**
   - Сохранять результаты отправок, настраивать алерты при сбоях.
5. **Тесты:**
   - Юнит-тесты планировщика и сервиса напоминаний.
   - Интеграционный тест фоновой задачи (можно через фейковый адаптер).

## 5. Письма при регистрации бизнеса и модерации
1. **Регистрация бизнеса:**
   - В обработчике создания бизнеса отправлять приветственное письмо на указанный бизнес-адрес через Brevo.
2. **Модерация:**
   - Подключить уведомления к административным методам утверждения/отклонения.
   - Использовать шаблоны для уведомлений о статусе заявки.
3. **Дополнительные данные:**
   - Добавить ссылку на личный кабинет, инструкции по заполнению профиля.
4. **Тестирование:**
   - Тесты на триггеры отправки и корректность шаблонов.

## 6. Приветствие или верификация нового пользователя
1. **Триггер:**
   - Регистрация клиента через общий маршрут.
2. **Выбор сценария:**
   - Приветственное письмо и/или письмо с ссылкой для подтверждения email.
3. **Реализация:**
   - Расширить сервис уведомлений поддержкой типа "verification".
   - Добавить таблицу/поле для токена подтверждения, настроить эндпоинт подтверждения.
   - Использовать Brevo SMTP для отправки писем с подтверждением.
4. **UX:**
   - Отразить ожидание письма в UI.
5. **Тесты:**
   - Юнит-тест генерации токена и шаблона.
   - Интеграционный тест регистрации пользователя с отправкой.

## Общие технические задачи
- Создать модуль `EmailService` с адаптером под Brevo SMTP (Sendinblue).
- Вынести шаблоны в отдельную директорию (например, `backend/mail_templates/`).
- Реализовать конфигурационный модуль, который использует уже подготовленные SMTP-параметры.
- Добавить ретраи и очередь сообщений для критичных писем.
- Обновить документацию API, описав новые уведомления и требуемые поля.
