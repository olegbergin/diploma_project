# План постепенного рефакторинга

## Цели
- Сохранить текущую стабильность продакшена: все изменения проходят через feature-флаги либо изолированные ветки с регрессионным тестированием.
- Упростить кодовую базу, устранить дублирование и «мертвый» код, стандартизировать работу с БД и HTTP-API.
- Подготовить проект к дальнейшему расширению: чёткие слои, единый стиль ошибок и тестовое покрытие критичных путей.

## Дорожная карта

### Этап 1. Срочная стабилизация
- **Бэкенд**
  - `backend/controllers/appointmentController.js`: удалить дублированные определения, вынести запросы в сервис; в роуты вернуть корректные статусы.
  - `backend/controllers/businessController.js`: устранить двойное объявление `getBusinessById`, покрыть тестами happy-path и ошибки.
  - `backend/routes/cleanup.js`, `routes/admin.js`: добавить middleware авторизации, переключить опасные операции на асинхронные версии `fs`.
  - Заполнить `controllers/reviewController.js` базовой CRUD-реализацией, сверившись с фронтенд-запросами.
- **Фронтенд**
  - Починить `BookingConfirmation.jsx` (завершить импорт, добавить экспортируемые пропы) и прогнать Vite build.
  - Стандартизировать запросы на `axiosInstance` (особенно `BusinessProfile/api/appointments.js`).
  - Добавить guard'ы вокруг использования `window`/`document` в хуках (`usePullToRefresh` и др.).
- **Тесты**
  - Реанимировать и стабилизировать существующие тесты в `backend/tests`, исправить моки `dbSingleton`.

### Этап 2. Стандартизация слоёв
- **Инфраструктура БД**
  - Превратить `dbSingleton` в класс с явным пулом (`mysql2/promise`), отдающий только async/await API; переписать контроллеры под единый интерфейс.
  - Ввести слой репозиториев (`backend/repositories/*`) для SQL-запросов, чтобы контроллеры занимались валидацией и формированием ответов.
- **Сервисы и контроллеры**
  - Собрать «толстые» контроллеры (админ, бизнес) в сервисы с чистыми функциями, покрытыми unit-тестами.
  - Для отчётности: разделить сбор данных и генерацию PDF, применить dependency injection для `pdfService` (удобно мокать в тестах).
- **Фронтенд**
  - Вынести повторяющиеся вызовы API в модуль `frontend/src/api/*` (REST-клиенты), использовать React Query или аналог для кеширования.
  - Разделить компоненты по слоям: `pages`, `features`, `ui`. Общие компоненты переименовать в `shared` и задокументировать пропсы с TypeScript или JSDoc.
  - Добавить централизованный обработчик ошибок/тостов в контекст, убрать локальные дублирования.
- Добавить централизованный обработчик ошибок (middleware).