# План постепенного рефакторинга

## Цели
- Сохранить текущую стабильность продакшена: все изменения проходят через feature-флаги либо изолированные ветки с регрессионным тестированием.
- Упростить кодовую базу, устранить дублирование и «мертвый» код, стандартизировать работу с БД и HTTP-API.
- Подготовить проект к дальнейшему расширению: чёткие слои, единый стиль ошибок и тестовое покрытие критичных путей.

## Принципы
1. **Маленькие инкременты.** Каждый шаг оформляется отдельной задачей/PR с автоматическими и ручными проверками.
2. **Обратная совместимость.** Новые API и схемы данных вводятся параллельно со старыми, миграции выполняются в режиме read-only → read/write.
3. **Обязательные тесты.** Перед слиянием — unit, e2e, smoke-тесты критических сценариев (аутентификация, бронирование, отчёты).
4. **Документация.** После каждой крупной правки обновляется `architecture.md` и схемы API.

## Дорожная карта

### Этап 0. Страховка (до начала рефакторинга)
- Настроить CI (GitHub Actions) с запуском `npm test` для фронтенда и бэкенда, линтеров (`eslint`, `stylelint`).
- Зафиксировать слепок схемы БД и наполнить тестовую базу данными из `db_dump.sql` для локальных проверок.
- Создать smoke-тесты для основных пользовательских путей (регистрация, вход, бронирование, генерация отчёта) с помощью Playwright или Cypress.

### Этап 1. Срочная стабилизация
- **Бэкенд**
  - `backend/controllers/appointmentController.js`: удалить дублированные определения, вынести запросы в сервис; в роуты вернуть корректные статусы.
  - `backend/controllers/businessController.js`: устранить двойное объявление `getBusinessById`, покрыть тестами happy-path и ошибки.
  - `backend/routes/cleanup.js`, `routes/admin.js`: добавить middleware авторизации, переключить опасные операции на асинхронные версии `fs`.
  - Заполнить `controllers/reviewController.js` базовой CRUD-реализацией, сверившись с фронтенд-запросами.
- **Фронтенд**
  - Починить `BookingConfirmation.jsx` (завершить импорт, добавить экспортируемые пропы) и прогнать Vite build.
  - Стандартизировать запросы на `axiosInstance` (особенно `BusinessProfile/api/appointments.js`).
  - Добавить guard'ы вокруг использования `window`/`document` в хуках (`usePullToRefresh` и др.).
- **Тесты**
  - Реанимировать и стабилизировать существующие тесты в `backend/tests`, исправить моки `dbSingleton`.

### Этап 2. Стандартизация слоёв
- **Инфраструктура БД**
  - Превратить `dbSingleton` в класс с явным пулом (`mysql2/promise`), отдающий только async/await API; переписать контроллеры под единый интерфейс.
  - Ввести слой репозиториев (`backend/repositories/*`) для SQL-запросов, чтобы контроллеры занимались валидацией и формированием ответов.
- **Сервисы и контроллеры**
  - Собрать «толстые» контроллеры (админ, бизнес) в сервисы с чистыми функциями, покрытыми unit-тестами.
  - Для отчётности: разделить сбор данных и генерацию PDF, применить dependency injection для `pdfService` (удобно мокать в тестах).
- **Фронтенд**
  - Вынести повторяющиеся вызовы API в модуль `frontend/src/api/*` (REST-клиенты), использовать React Query или аналог для кеширования.
  - Разделить компоненты по слоям: `pages`, `features`, `ui`. Общие компоненты переименовать в `shared` и задокументировать пропсы с TypeScript или JSDoc.
  - Добавить централизованный обработчик ошибок/тостов в контекст, убрать локальные дублирования.

### Этап 3. Улучшение DX и расширяемости
- Внедрить ESLint/Prettier конфигурацию, согласованную для фронта и бэка (например, Airbnb + plugin:react).
- Добавить type-checking: TypeScript для фронтенда (с постепенной миграцией файлов) и JSDoc/ts-node для бэкенда.
- Настроить Storybook для визуальных компонентов, чтобы упрощать регрессию UI.
- Реализовать e2e сценарии бронирования и отчётности в CI.

### Этап 4. Дальнейшие улучшения (при наличии времени)
- Перейти на модульный подход к маршрутизации бэкенда (например, `express.Router` + `asyncHandler`) с автоматическим подключением через индексный файл.
- Добавить rate limiting, audit-логирование административных операций и централизованный обработчик ошибок (middleware).
- Рассмотреть разделение репозитория на backend/frontend пакеты с использованием pnpm workspace или Turborepo.

## Управление рисками
- Каждое изменение в контроллерах — за feature-флагом или через новый endpoint (`/v2`). Старые версии удаляются после успешного релиза.
- Для критичных функций (аутентификация, бронирование, отчёты) поддерживать "blue/green" деплой: сначала катим новый инстанс, затем переключаем трафик.
- При внедрении TypeScript включить `allowJs`, постепенно ужесточая конфигурацию.
- Раз в спринт проводить аудит безопасности (SQL-инъекции, XSS, права доступа) и обновлять зависимости.

